<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>菠萝瑜的丑网页</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* 所有之前的样式保持不变 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-top: 20px;
    }
    
    header h1 {
      font-size: 2.8rem;
      color: #6A5ACD;
      margin-bottom: 10px;
      background: linear-gradient(to right, #3498db, #2c3e50);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    header p {
      color: #7f8c8d;
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0 auto;
    }
    
    .input-section {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      padding: 30px;
      margin-bottom: 40px;
      transition: transform 0.3s ease;
    }
    
    .input-section:hover {
      transform: translateY(-5px);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #34495e;
    }
    
    .form-group input, 
    .form-group textarea {
      width: 100%;
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      transition: border 0.3s ease;
    }
    
    .form-group input:focus, 
    .form-group textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    .submit-btn {
      background: linear-gradient(to right, #3498db, #2c3e50);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 28px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
    }
    
    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 15px rgba(52, 152, 219, 0.4);
    }
    
    .submit-btn i {
      margin-right: 8px;
    }
    
    .feedback-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eaeaea;
    }
    
    .feedback-header h2 {
      font-size: 1.8rem;
      color: #2c3e50;
    }
    
    .sort-option {
      background: #eaf2f8;
      padding: 8px 15px;
      border-radius: 20px;
      color: #3498db;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
    }
    
    .sort-option i {
      margin-right: 5px;
    }
    
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 30px;
      margin-bottom: 50px;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      transition: all 极客时间·0.3s ease;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
      display:极客时间· flex;
      align-items: center;
    }
    
    .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(45deg, #3498db, #2ecc71);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
      margin-right: 15px;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-info h3 {
      font-size: 18px;
      color: #2c3e50;
      margin-bottom: 3px;
    }
    
    .user-info p {
      color: #7f8c8d;
      font-size: 14px;
    }
    
    .card-content {
      padding: 25px 20px;
      flex: 1;
      color: #34495e;
      line-height: 1.6;
      font-size: 16px;
    }
    
    .card-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .likes {
      display: flex;
      align-items: center;
      color: #FFE4E1;
    }
    
    .like-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: #95a5a6;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      margin-right: 10px;
    }
    
    .like-btn:hover {
      background: rgba(231, 76, 60, 0.1);
      transform: scale(1.1);
      color: #e74c3c;
    }
    
    .liked {
      color: #e74c3c !important;
    }
    
    .like-count {
      font-weight: 600;
      font-size: 16px;
    }
    
    .timestamp {
      color: #95a5a6;
      font-size: 14px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #7f8c8d;
      grid-column: 1 / -1;
    }
    
    .empty-state i {
      font-size: 80px;
      color: #bdc3c7;
      margin-bottom: 20px;
    }
    
    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    @media (max-width: 768px) {
      .input-section {
        padding: 20px;
      }
      
      .cards-container {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      }
      
      .feedback-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .feedback-header .sort-option {
        margin-top: 15px;
      }
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2ecc71;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      font-weight: 500;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      transform: translateX(120%);
      transition: transform 0.4s ease;
      z-index: 1000;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .system-status {
      background: rgba(52, 152, 219, 0.1);
      border-radius: 10px;
      padding: 15px 20px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      font-size: 16px;
    }
    
    .system-status i {
      margin-right: 12px;
      font-size: 20px;
      color: #3498db;
    }
    
    .system-status.connected {
      background: rgba(46, 204, 113, 0.1);
    }
    
    .system-status.connected i {
      color: #27ae60;
    }
    
    .loading-indicator {
      text-align: center;
      padding: 20px;
      font-size: 18px;
      color: #7f8c8d;
    }
    
    .loading-indicator i {
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>菠萝瑜的丑网页</h1>
      <p>所有人都可以发布和查看反馈，并为喜欢的反馈点赞！本页面使用Firebase作为后端，确保所有访问者看到相同的内容</p>
    </header>
    
    <div class="system-status" id="systemStatus">
      <i class="fas fa-plug"></i>
      <div>正在连接到数据库...</div>
    </div>
    
    <section class="input-section">
      <form id="feedbackForm">
        <div class="form-group">
          <label for="userName">您的姓名</label>
          <input type="text" id="userName" placeholder="请输入您的姓名" required>
        </div>
        
        <div class="form-group">
          <label for="userFeedback">您对菠萝瑜有什么想说的</label>
          <textarea id="userFeedback" placeholder="请描述您的问题、建议或想法..." required></textarea>
        </div>
        
        <button type="submit" class="submit-btn">
          <i class="fas fa-paper-plane"></i> 发布留言
        </button>
      </form>
    </section>
    
    <div class="feedback-header">
      <h2>用户留言 (<span id="feedbackCount">0</span>)</h2>
      <div class="sort-option">
        <i class="fas fa-sort-amount-down-alt"></i> 按点赞数排序
      </div>
    </div>
    
    <div class="cards-container" id="cardsContainer">
      <div class="loading-indicator">
        <i class="fas fa-spinner"></i> 正在加载反馈数据...
      </div>
    </div>
  </div>
  
  <!-- 操作结果提示 -->
  <div class="notification" id="notification">反馈已成功发布！</div>
  
  <!-- Firebase SDK（使用模块化版本） -->
  <script type="module">
    // ========== Firebase配置（使用您从控制台复制的配置）==========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, get, child } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js";
    
    // 请替换为您自己的Firebase配置
    const firebaseConfig = {
      apiKey: "AIzaSyDRRrQDpRYMZa7EchXyFB36rcTXuTBw1p0",
      authDomain: "imafeedback.firebaseapp.com",
      databaseURL: "https://imafeedback-default-rtdb.firebaseio.com",
      projectId: "imafeedback",
      storageBucket: "imafeedback.firebasestorage.app",
      messagingSenderId: "904754116201",
      appId: "1:904754116201:web:5937383bd4523e432794f8",
      measurementId: "G-PB7CCQNFT1"
    };

    // 初始化Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    // 数据库连接状态
    const systemStatus = document.getElementById('systemStatus');
    systemStatus.className = 'system-status connected';
    systemStatus.innerHTML = '<i class="fas fa-check-circle"></i><div>已连接到Firebase数据库，数据实时同步中...</div>';

    // ========== 主应用逻辑 ==========
    // 获取或创建用户唯一标识
    function getOrCreateUserId() {
      let userId = localStorage.getItem('feedbackUserId');
      if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('feedbackUserId', userId);
      }
      return userId;
    }
    
    // 显示通知
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // 渲染反馈卡片
    function renderFeedbacks(feedbacks) {
      const container = document.getElementById('cardsContainer');
      const countElement = document.getElementById('feedbackCount');
      
      // 如果没有反馈数据
      if (!feedbacks) {
        container.innerHTML = `
          <div class="empty-state">
            <极客时间·i class="fas fa-comment-alt"></i>
            <h3>暂无反馈</h3>
            <p>成为第一个分享想法的人吧！</p>
          </div>
        `;
        countElement.textContent = '0';
        return;
      }
      
      // 将反馈转换为数组并按点赞数排序
      const feedbacksArray = Object.keys(feedbacks).map(id => {
        return { id, ...feedbacks[id] };
      });
      const sortedFeedbacks = feedbacksArray.sort((a, b) => (b.likes || 0) - (a.likes || 0));
      
      // 更新计数
      countElement.textContent = sortedFeedbacks.length;
      
      // 渲染反馈卡片
      container.innerHTML = sortedFeedbacks.map(feedback => {
        const userId = getOrCreateUserId();
        const hasLiked = feedback.likedBy && feedback.likedBy[userId];
        const date = new Date(feedback.timestamp);
        const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        
        return `
          <div class="card" data-id="${feedback.id}">
            <div class="card-header">
              <div class="avatar">${feedback.name.charAt(0)}</div>
              <div class="user-info">
                <h3>${feedback.name}</h3>
                <p>发布于: ${formattedDate}</p>
              </div>
            </div>
            <div class="card-content">
              ${feedback.feedback}
            </div>
            <div class="card-footer">
              <div class="likes">
                <button class="like-btn ${hasLiked ? 'liked' : ''}" aria-label="点赞" data-id="${feedback.id}">
                  <i class="fas fa-heart"></i>
                </button>
                <span class="like-count">${feedback.likes || 0}</span>
              </div>
              <div class="timestamp">${feedback.likes || 0}人点赞</div>
            </div>
          </div>
        `;
      }).join('');
      
      // 添加点赞事件监听器
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', handleLike);
      });
    }
    
    // 处理点赞功能
    async function handleLike(e) {
      const feedbackId = e.currentTarget.dataset.id;
      const userId = getOrCreateUserId();
      
      // 获取当前反馈的完整数据
      const feedbackRef = ref(database, `feedbacks/${feedbackId}`);
      const snapshot = await get(feedbackRef);
      
      if (!snapshot.exists()) return;
      
      const feedback = snapshot.val();
      
      // 确保likedBy对象存在
      if (!feedback.likedBy) {
        feedback.likedBy = {};
      }
      
      // 检查用户是否已经点过赞
      if (feedback.likedBy[userId]) {
        // 用户已经点过赞，取消点赞
        feedback.likes = (feedback.likes || 0) - 1;
        feedback.likedBy[userId] = false;
      } else {
        // 用户还未点赞，添加点赞
        feedback.likes = (feedback.likes || 0) + 1;
        feedback.likedBy[userId] = true;
      }
      
      // 更新数据库
      try {
        await update(feedbackRef, {
          likes: feedback.likes,
          likedBy: feedback.likedBy
        });
        
        // 更新UI状态
        if (feedback.likedBy[userId]) {
          e.currentTarget.classList.add('liked');
        } else {
          e.currentTarget.classList.remove('liked');
        }
        
        // 更新点赞数显示
        const likeCount = e.currentTarget.nextElementSibling;
        likeCount.textContent = feedback.likes;
        
        // 更新时间戳显示
        const cardFooter = e.currentTarget.closest('.card-footer');
        cardFooter.querySelector('.timestamp').textContent = `${feedback.likes}人点赞`;
      } catch (error) {
        console.error("点赞更新失败: ", error);
        showNotification("操作失败，请重试");
      }
    }
    
    // 处理表单提交
    async function handleSubmit(e) {
      e.preventDefault();
      
      const userName = document.getElementById('userName').value.trim();
      const userFeedback = document.getElementById('userFeedback').value.trim();
      
      if (!userName || !userFeedback) {
        showNotification('请填写完整信息！');
        return;
      }
      
      // 创建新的反馈对象
      const newFeedbackId = Date.now().toString();
      const newFeedback = {
        name: userName,
        feedback: userFeedback,
        likes: 0,
        likedBy: {},
        timestamp: new Date().toISOString()
      };
      
      // 添加到数据库
      try {
        await set(ref(database, `feedbacks/${newFeedbackId}`), newFeedback);
        showNotification('您的反馈已成功发布！');
        document.getElementById('feedbackForm').reset();
      } catch (error) {
        console.error("发布反馈失败: ", error);
        showNotification('发布失败，请重试');
      }
    }
    
    // ========== 页面初始化 ==========
    document.addEventListener('DOMContentLoaded', () => {
      // 添加表单提交事件
      document.getElementById('feedbackForm').addEventListener('submit', handleSubmit);
      
      // 监听数据库变化
      const feedbackRef = ref(database, 'feedbacks');
      onValue(feedbackRef, (snapshot) => {
        const feedbacks = snapshot.val();
        renderFeedbacks(feedbacks);
      }, (error) => {
        console.error("数据库读取失败: ", error);
        systemStatus.className = 'system-status';
        systemStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i><div>数据库连接错误，请刷新页面</div>';
      });
    });
  </script>
</body>
</html>